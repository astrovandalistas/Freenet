<!DOCTYPE html>

<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>Campo de Afinidades Ubícuoas</title>
    <script type="text/javascript" src="/Users/thiago/Dev/d3.v3/d3.v3.js"></script>
    <style type="text/css">
        circle.node {
            font-family: sans-serif;
            stroke-width: 1.5px;
            stroke: gray;
            fill: white;
        }
        line.node {
            font-family: sans-serif;
            stroke: black;
            stroke-width: 1.5px;
        }
        #graph{
        	width: 80%;
        	margin: 0 auto;
        	border-radius: 8px;
        	border-width: 2px;
        	border-color: black;
        	border-style: solid;
        	background-color: #FFFFFF;
        }
        #stream{
        	width: 80%;
        	margin: 0 auto;
        	border-radius: 8px;
        	margin-top: 10px;
        	border-width: 2px;
        	border-color: black;
        	border-style: solid;
        	background-color: #FFFFFF;
        }
        #info{
        	width: 80%;
        	margin: 0 auto;
        	border-radius: 8px;
        	border-width: 2px;
        	border-color: black;
        	border-style: solid;
        	background-color: #FFFFFF;
        	margin-top: 10px;
        }
        #stream-title{
        	width: 100%;
        	font-size: 18pt;
        	font-weight: bold;
        	border-top-right-radius: 8px;
        	border-top-left-radius: 8px;
        	background-color: #FFFFFF;
        	border-bottom-width: 1px;
        	border-bottom-color: #EFEFEF;
        	border-bottom-style: solid;
        }
        #stream-messages{
        	width: 100%;
        	background-color: #AF6060;
        }
        #stream-message{
        	width: 100%;
        	font-size: 12pt;
        	font-weight: normal;
        	background-color: #FFFFFF;
        	border-bottom-width: 1px;
        	border-bottom-color: #EFEFEF;
        	border-bottom-style: solid;
        }
        #stream-footer{
        	width: 100%;
        	text-align: center;
        	border-bottom-right-radius: 8px;
        	border-bottom-left-radius: 8px;
        	background-color: #FFFFFF;
        }
    </style>
</head>
<body style="background-color: #D5D5D5">
    <div id="graph"></div>
    <div id="info"></div>
    <div id="stream">
        <div id="stream-title"></div>
        <div id="stream-messages"></div>
        <div id="stream-footer"></div>
    </div>

    <script type="text/javascript">

	var nets = [{name: "MOLAA",
				location: "Los Angeles, CA",
				description: "MOLAA blah blah blah",
				image: "http://i.imgur.com/OV5JNjB.jpg",
				active: true,
				_prots: [{name: "AST",
						description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
    					{name: "CAU",
    					description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
			    		{name: "ISO",
			    		description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
			    		{name: "VLE",
			    		description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"}]
				},
				{name: "542",
				location: "Oakland, CA",
				description: "542 blah blah blah",
				image: "http://i.imgur.com/OV5JNjB.jpg",
				active: false,
				_prots: [{name: "AST",
						description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
    					{name: "CAU",
    					description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
			    		{name: "ISO",
			    		description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"},
			    		{name: "VLE",
			    		description: "ohh lalalala",
						image: "http://i.imgur.com/OV5JNjB.jpg"}]
				}];

	var msgs = ["hello", 
				"no man. this is a longer message to see what would happen with 140 characters, but it’s hard for me to write that much. We’ll never know.", 
				"make some noise", 
				"unbelibubble"];

	var nodes = [],
		links = [];

	updateNodeAndLinkArrays();

    var graphSVG = d3.select("#graph")
        .append("svg")
        .attr("width", 800)
        .attr("height", 200);

    d3.select("#stream-title").text("Messages");
	d3.select("#stream-footer").insert("img")
		.attr("src","http://i.imgur.com/OV5JNjB.jpg")
		.attr("height","50px");


    var stream = d3.select("#stream-messages");
    stream.selectAll("div")
    	.data(msgs)
    	.enter().append("div")
    	.attr("id","stream-message")
    	.text(function(d){return d;});

	updateGraphSVG();

    var theForce = d3.layout.force();

	theForce.nodes(nodes)
		.links(links)
		.linkDistance(50)
		.charge(-100)
		.size([800,200])
		.on("tick",tick)
		.start();

	function tick(){
		// TODO: color
		graphSVG.selectAll("line.node")
			.attr("x1", function(d){return d.source.x;})
			.attr("y1", function(d){return d.source.y;})
			.attr("x2", function(d){return d.target.x;})
			.attr("y2", function(d){return d.target.y;});
		graphSVG.selectAll("circle.node")
			.attr("cx", function(d){return d.x;})
			.attr("cy", function(d){return d.y;})
			.attr("r", function(d){return (("prots" in d)||("_prots" in d))?20:10});
	}

	function updateNodeAndLinkArrays() {
		nodes = []; 
		links = [];
		for (var n in nets){
			var s = nodes.length;
			nodes.push(nets[n]);
			for (var p in nets[n].prots){
				var t = nodes.length;
				nodes.push(nets[n].prots[p]);
				links.push({source:s, target:t});
			}
		}
	}

	function updateGraphSVG() {
		graphSVG.selectAll("line").remove();
		graphSVG.selectAll("circle").remove();
		graphSVG.selectAll("line")
			.data(links)
			.enter().append("svg:line")
			.attr("class", "node");
		graphSVG.selectAll("circle")
			.data(nodes)
			.enter().append("svg:circle")
			.attr("class", "node")
			.on("click", nodeClick);
	}

	function nodeClick(n){
		var txt = "";
		// closing net
		if(n.prots){
			n._prots = n.prots;
			n.prots = null;
		}
		// re-opening net
		else if(("prots" in n)||("_prots" in n)){
			n.prots = n._prots;
			n._prots = null;
			// setup network info bar
			txt = n.name+" "+n.description;
		}
		else{
			// setup prototype info bar
			txt = n.name+" "+n.description;
		}
		// put text in info bar
		d3.select("#info").text(txt);
		// update node arrays
		updateNodeAndLinkArrays();
		// update svg
		updateGraphSVG();
		// update graph
		theForce.nodes(nodes)
			.links(links)
			.start();
	}

    </script>
</body>
</html>
